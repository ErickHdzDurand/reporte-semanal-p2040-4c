-- âœ… EXPORT con indicadores EDU_INSCRITOS usando snapshot directo (Educacion_4c_snapshot)
EXPORT DATA OPTIONS (
  uri = 'gs://bucket_1_p2040/html/datos_educacion_4c*.csv',
  format = 'CSV',
  overwrite = true,
  header = true
)
AS
WITH base AS (
  SELECT
    periodo_semanal AS semana_inicio,
    crmID,
    LOWER(CAST(status_escuela AS STRING)) AS status_escuela,
    CAST(plan_ AS STRING) AS plan,
    CAST(estatus AS STRING) AS estatus,
    generacion
  FROM `posgre-plan2040.SNAPSHOT4C.Educacion_4c_snapshot`
  WHERE estatus = 'Activo'
    AND plan_ = 'P2040'
    AND generacion IN ('15 - 16', '16 - 17', '17 - 18', '18 - 19', '19 - 20', '20 - 21', '21 - 22', '22 - 23', '23 - 24', '24 - 25', '25 - 26')
),
conteos AS (
  SELECT
    semana_inicio,
    COUNT(DISTINCT CASE WHEN status_escuela IN ('en curso', 'cursando') THEN crmID END) AS total_p2040,
    COUNT(DISTINCT CASE WHEN status_escuela = 'preinscrito' THEN crmID END) AS edu_inscritos
  FROM base
  GROUP BY semana_inicio
),
con_porcentaje AS (
  SELECT *, SAFE_DIVIDE(edu_inscritos, total_p2040) AS pct_edu FROM conteos
),
con_variacion AS (
  SELECT *,
    SAFE_MULTIPLY(
      SAFE_DIVIDE(pct_edu - LAG(pct_edu) OVER (ORDER BY semana_inicio), LAG(pct_edu) OVER (ORDER BY semana_inicio)),
      100
    ) AS var_pct_edu
  FROM con_porcentaje
)
-- EXPORT
SELECT 'edu_u2040_' || FORMAT_DATE('%b%d', semana_inicio) AS indicador_id, FORMAT_DATE('%b%d', semana_inicio) AS periodo, total_p2040 AS valor, semana_inicio FROM con_variacion
UNION ALL SELECT 'edu_inscritos_p2040_' || FORMAT_DATE('%b%d', semana_inicio), FORMAT_DATE('%b%d', semana_inicio), edu_inscritos, semana_inicio FROM con_variacion
UNION ALL SELECT 'edu_inscritos_pct_' || FORMAT_DATE('%b%d', semana_inicio), FORMAT_DATE('%b%d', semana_inicio), ROUND(pct_edu * 100, 1), semana_inicio FROM con_variacion
UNION ALL SELECT 'edu_inscritos_var_' || FORMAT_DATE('%b%d', semana_inicio), FORMAT_DATE('%b%d', semana_inicio), ROUND(var_pct_edu, 1), semana_inicio FROM con_variacion


--------




